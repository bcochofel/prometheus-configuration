groups:
# Rules for Node Exporter
- name: Node Exporter rules
  rules:
  # Node Exporter is down
  - alert: NodeExporterDown
    expr: up{job="node_exporter"} == 0
    for: 5m
    labels:
      severity: critical
      team: devops
    annotations:
      title: Node exporter down.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: Node exporter down for the past 5m.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

# Rules for CPU
- name: Node Exporter CPU rules
  rules:
  # The count of CPUs per node, useful for getting CPU time as a percent of total.
  - record: instance:node_cpus:count
    expr: >
      count without (cpu, mode) (
        node_cpu_seconds_total{mode="idle"}
      )
  # CPU in use by CPU.
  - record: instance_cpu:node_cpu_seconds_not_idle:rate1m
    expr: >
      sum without (mode) (
        rate(node_cpu_seconds_total{mode!="idle"}[1m])
      )
  # CPU in use by mode.
  - record: instance_mode:node_cpu_seconds:rate1m
    expr: >
      sum without (cpu) (
        rate(node_cpu_seconds_total[1m])
      )
  - record: instance_mode:node_cpu_seconds:rate5m
    expr: >
      sum without (cpu) (
        rate(node_cpu_seconds_total[5m])
      )
  # CPU in use ratio.
  - record: instance:node_cpu_utilization:ratio
    expr: >
      sum without (mode) (
        instance_mode:node_cpu_seconds:rate1m{mode!="idle"}
      ) / instance:node_cpus:count
  # CPU saturation
  - record: instance:node_cpu_saturation:ratio
    expr: node_load1 / instance:node_cpus:count

  # CPU Alerts

  # CPU High Utilization
  - alert: CPU-HighUtilization
    expr: instance:node_cpu_utilization:ratio * 100 > 95
    for: 15m
    labels:
      severity: critical
      team: devops
    annotations:
      title: CPU use percent is extremely high.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: CPU use percent is extremely high for the past 15m.
        CPU utilization is above 95%.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

  # CPU Saturation
  - alert: CPU-HighSaturation
    expr: instance:node_cpu_saturation:ratio * 100 > 95
    for: 15m
    labels:
      severity: critical
      team: devops
    annotations:
      title: CPU saturation is extremely high.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: CPU saturation is extremely high for the past 15m.
        CPU saturation is above 95%.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

# Rules for Load
- name: Node Exporter Load rules
  rules:
  # Load warning
  - alert: Load-WarningUsage
    expr: >
      avg by (instance, fqdn) (
        (node_load5 / instance:node_cpus:count) > 4
      )
    for: 15m
    labels:
      severity: warning
      team: devops
    annotations:
      title: Load avg is high.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: Load average is high for the past 15m.
        The Load average is above 4.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

  # Load high
  - alert: Load-HighUsage
    expr: >
      avg by (instance, fqdn) (
        (node_load5 / instance:node_cpus:count) > 7
      )
    for: 15m
    labels:
      severity: warning
      team: devops
    annotations:
      title: Load avg is high.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: Load average is high for the past 15m. 
        The Load average is above 7.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

# Rules for Memory
- name: Node Exporter Memory rules
  rules:
  - record: instance:node_memory_available:ratio
    expr: >
      (
        node_memory_MemAvailable_bytes or
        (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)
      ) / node_memory_MemTotal_bytes
  - record: instance:node_memory_utilization:ratio
    expr: 1 - instance:node_memory_available:ratio

  # Memory Alerts
  # High Memory with major page faults
  - alert: HighMemoryPressure
    expr: >
      instance:node_memory_available:ratio * 100 < 5 and rate(node_vmstat_pgmajfault[1m]) > 1000
    for: 15m
    labels:
      severity: critical
      team: devops
    annotations:
      title: Memory is under heavy pressure.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: Memory is under heavy pressure for the past 15m. 
        The available memory is under 5% and there is a high rate of major page faults.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

  # Memory is filling up
  - alert: MemoryFillingUp
    expr: >
      (
        node_memory_MemFree_bytes + node_memory_Cached_bytes + node_memory_Buffers_bytes
      ) / node_memory_MemTotal_bytes * 100 < 10
    for: 30m
    labels:
      severity: warning
      team: devops
    annotations:
      title: Node memory is filling up.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: Node memory is filling up (< 10% left) for the past 30m.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

  # Swap usage high
  - alert: SwapUsageHigh
    expr: >
      (
        ((node_memory_SwapTotal - node_memory_SwapFree) / node_memory_SwapTotal) * 100
      ) > 95
    for: 30m
    labels:
      severity: warning
      team: devops
    annotations:
      title: High swap usage.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: Swap usage above 95% for the past 30m.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

# Rules for calculating and alerting on long-term node utilization issues.
- name: Node Exporter Utilization (USE method)
  interval: 300s
  rules:
  - record: instance:cpu_utilization:ratio_max
    expr: max_over_time(instance:node_cpu_utilization:ratio[300s])
  - record: instance:cpu_utilization:ratio_avg
    expr: avg_over_time(instance:node_cpu_utilization:ratio[300s])
  - record: instance:cpu_utilization:ratio_q95
    expr: quantile_over_time(0.95, instance:node_cpu_utilization:ratio[300s])
  - record: instance:memory_utilization:ratio_max
    expr: max_over_time(instance:node_memory_utilization:ratio[300s])
  - record: instance:memory_utilization:ratio_avg
    expr: avg_over_time(instance:node_memory_utilization:ratio[300s])
  - record: instance:memory_utilization:ratio_q95
    expr: quantile_over_time(0.95, instance:node_memory_utilization:ratio[300s])

# Rules for Disk
- name: Node Exporter Disk rules
  rules:
#  - record: instance:node_disk_writes_completed:irate1m
#    expr: sum(irate(node_disk_writes_completed_total{device=~"sd.*"}[1m])) WITHOUT (device)
#  - record: instance:node_disk_reads_completed:irate1m
#    expr: sum(irate(node_disk_reads_completed_total{device=~"sd.*"}[1m])) WITHOUT (device)

  # Disk alerts

  # Unusual disk read rate
  - alert: UnusualDiskReadRate
    expr: sum by (instance) (irate(node_disk_read_bytes_total[5m])) / 1024 / 1024 > 500
    for: 30m
    labels:
      severity: warning
      team: devops
    annotations:
      title: Unusual disk read rate.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: Disk is probably reading too much data (> 500MB/s) for the last 30m.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

  # Unusual disk write rate
  - alert: UnusualDiskWriteRate
    expr: sum by (instance) (irate(node_disk_written_bytes_total[5m])) / 1024 / 1024 > 500
    for: 30m
    labels:
      severity: warning
      team: devops
    annotations:
      title: Unusual disk write rate.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: Disk is probably writing too much data (> 500MB/s) for the last 30m.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

  # Unusual disk read latency
  - alert: UnusualDiskReadLatency
    expr: rate(node_disk_read_time_seconds_total[1m]) / rate(node_disk_reads_completed_total[1m]) > 100
    for: 30m
    labels:
      severity: warning
      team: devops
    annotations:
      title: Unusual disk read latency.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: Disk latency is growing (read operations > 100ms) for the last 30m.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

  # Unusual disk write latency
  - alert: UnusualDiskWriteLatency
    expr: rate(node_disk_write_time_seconds_total[1m]) / rate(node_disk_writes_completed_total[1m]) > 100
    for: 30m
    labels:
      severity: warning
      team: devops
    annotations:
      title: Unusual disk write latency.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: Disk latency is growing (write operations > 100ms) for the past 30m.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

# Rules for filesystem
- name: Node Exporter Filesystem rules
  rules:
  - record: instance:node_filesystem_avail:ratio
    expr: node_filesystem_avail_bytes{device=~"/dev/.+"} / node_filesystem_size_bytes{device=~"/dev/.+"}

  # Filesystem alerts

  # Filesystem Full Soon
  - alert: FilesystemFullSoon
    expr: predict_linear(node_filesystem_avail_bytes{fstype=~"(ext.|xfs)"}[6h], 24 * 3600) < 0
    for: 30m
    labels:
      severity: warning
      team: devops
    annotations:
      title: Filesystem will be full SOON.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: The filesystem is predicted to be full in the next 24 hours.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

  # Low Disk space
  - alert: LowDiskSpace
    expr: instance:node_filesystem_avail:ratio{fstype=~"(ext.|xfs)",job="node_exporter"} * 100 <= 10
    for: 15m
    labels:
      severity: warning
      team: devops
    annotations:
      title: Less than 10% disk space left.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: Less than 10% disk space left for mountpoint {{ "{{" }} $labels.mountpoint {{ "}}" }} for the last 15m.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

  # No Disk space
  - alert: NoDiskSpace
    expr: instance:node_filesystem_avail:ratio{fstype=~"(ext.|xfs)",job="node_exporter"} * 100 <= 1
    for: 15m
    labels:
      severity: critical
      team: devops
    annotations:
      title: 1% disk space left.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: There's only 1% disk space left for mountpoint {{ "{{" }} $labels.mountpoint {{ "}}" }} for the last 15m.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

  # High Inode usage
  - alert: HighInodeUsage
    expr: node_filesystem_files_free{fstype=~"(ext.|xfs)",job="node"} / node_filesystem_files{fstype=~"(ext.|xfs)",job="node_exporter"}
      * 100 <= 20
    for: 15m
    labels:
      severity: critical
      team: devops
    annotations:
      title: High number of inode usage.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: High number of Inodes for mountpoint {{ "{{" }} $labels.mountpoint {{ "}}" }} for the last 15m.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

# Rules for Network
- name: Node Exporter Network rules
  rules:
  # Network alerts

  # Number of Bonding Slaves
  - alert: BondingSlaves
    expr: node_bonding_slaves < 2
    for: 30m
    labels:
      severity: warning
      team: devops
    annotations:
      title: Number of Bonding Slaves below 2.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: Number of Bonding Slaves below 2 for interface {{ "{{" }} $labels.master {{ "}}" }} for the last 30m.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

  # Unusual Network Throughput In
  - alert: UnusualNetworkThroughputIn
    expr: sum by (instance) (irate(node_network_receive_bytes_total[2m])) / 1024 / 1024 > 100
    for: 30m
    labels:
      severity: warning
      team: devops
    annotations:
      title: Unusual network throughput In.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: Host network interfaces are probably receiving too much data (> 100 MB/s) for the last 30m.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"

  # Unusual Network Throughput Out
  - alert: UnusualNetworkThroughputOut
    expr: sum by (instance) (irate(node_network_transmit_bytes_total[2m])) / 1024 / 1024 > 100
    for: 30m
    labels:
      severity: warning
      team: devops
    annotations:
      title: Unusual network throughput Out.
      runbook: 'http://runbooks.example.com/node_exporter_alerts.md'
      graph: 'http://grafana.example.com'
      description: Host network interfaces are probably sending too much data (> 100 MB/s) for the last 30m.
        "Host: {{ "{{" }} if $labels.host {{ "}}" }} {{ "{{" }} $labels.host {{ "}}" }}{{ "{{" }} else {{ "}}" }} {{ "{{" }} $labels.instance {{ "}}" }} {{ "{{" }} end {{ "}}" }}"
